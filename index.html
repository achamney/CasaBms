<html>

<head>
		<title>CasaBMS</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="icon" type="image/png" href="icon.png">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="style.css" />
	<style>
		
	</style>
</head>

<body>
	<div class="jumbotron jumbotron-fluid">
		<div class="container">
			<h1 class="display-4">CasaBMS</h1>
		</div>
	</div>
    <br/>
    <div class="container">
        <div class="barContainer">
            <div class="bar bar1">3.0v<span style="float: right" id="voltContainer"></span></div>
            <div class="bar bar2"><span style="float: right">4.2v</span></div>
        </div>
        <div class="clear"></div>
        <canvas id="voltChart"></canvas>
        <canvas id="tempChart"></canvas>
    </div>
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="display:none">
        <div class="toast-header">
          <strong class="mr-auto">Error</strong>
          <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body">
          Unable to retrieve data.
        </div>
      </div>
</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
	integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
	crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
	integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
	crossorigin="anonymous"></script>
<script src ="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script src="common.js"></script>
<script>
    window.setInterval(function() {
        refreshData();
    }, 15000);
    function refreshData() {
        getData(function(data) {
            window.allData = data;
            data.voltages.forEach(all=> all.v = all.v.map(v=>v*5/255));
            var lastVolt = data.voltages[data.voltages.length-1];
            var averageLast = lastVolt.v.reduce((a, b)=>a + b)/6;
            $("#voltContainer").html(averageLast.toFixed(2)+"v");
            var bar1w = (averageLast-3)/1.2 * 100;
            var bar2w = (4.2-averageLast)/1.2 * 100;
            $(".bar1").css("width",bar1w+"%");
            $(".bar2").css("width",bar2w+"%");
            data.voltages = data.voltages.map(all=> { return {
                "t": all.t, 
                "v": all.v.reduce((a, b)=>a + b)/6
                }
            });
            refreshChart("voltChart", data.voltages, "v");
            refreshChart("tempChart", data.voltages, "t");
        });
    }
    function refreshChart(id, data, datum) {
        var ctx = document.getElementById(id).getContext('2d');
        var time = new Date(allData._updatedOn);
        var timeWindow = 30;
        time = new Date(time - timeWindow * (data.length) * 1000);
        var chart = new Chart(ctx, {
            // The type of chart we want to create
            type: 'bar',

            // The data for our dataset
            data: {
                labels: data.map((d, i)=>{ time = new Date(time.getTime() + timeWindow*1000); 
                    return time.getHours()+":"+formatTime(time.getMinutes());}),
                datasets: [{
                    label: (datum == "v" ? "Volts" : "Temperature (C)"),
                    backgroundColor: function(context){
                        var index = context.dataIndex;
                        var value = context.dataset.data[index];
                        if (datum == "v")
                            return value<3.75 ? "#BA0" :
                                    value < 3.4 ? "red" :
                                    "green";
                        if (datum == "t")
                            return value>55 ? "#BA0" :
                                    value >75 ? "red" :
                                    "green";
                        return "#BA0";
                    },
                    borderColor: 'rgb(255, 99, 132)',
                    data: data.map(d=>d[datum])
                }]
            },

            // Configuration options go here
            options: { title: {
                    display: true,
                    text: datum == "v" ? "Voltage Over Time" : "Temperature Over Time (C)"
                },
                legend: {display: false }
            }
        });
    }
    function formatTime(t) {
        return t <= 9 ? "0"+t : t;
    }
    refreshData();
</script>

</html>